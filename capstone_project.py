{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 65,
   "id": "7082d9ef",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Connected to Binance Testnet\n"
     ]
    }
   ],
   "source": [
    "# ==========================================\n",
    "# 1. SETUP & CONFIGURATION\n",
    "# ==========================================\n",
    "import os\n",
    "import json\n",
    "import re\n",
    "import time\n",
    "import requests\n",
    "import pandas as pd\n",
    "from dotenv import load_dotenv\n",
    "from binance.client import Client\n",
    "from ta.trend import EMAIndicator\n",
    "from ta.momentum import RSIIndicator\n",
    "\n",
    "# Load environment variables from your local .env file\n",
    "load_dotenv()\n",
    "\n",
    "# Configuration\n",
    "BINANCE_TESTNET = True  # Set to False if using real money keys\n",
    "SYMBOL = \"ETHUSDT\"      # The symbol to analyze\n",
    "TIMEFRAME = \"5m\"        # Timeframe for candles\n",
    "\n",
    "# Initialize Binance Client\n",
    "try:\n",
    "    api_key = os.getenv(\"BINANCE_TEST_API_KEY\") if BINANCE_TESTNET else os.getenv(\"BINANCE_API_KEY\")\n",
    "    api_secret = os.getenv(\"BINANCE_TEST_API_SECRET\") if BINANCE_TESTNET else os.getenv(\"BINANCE_API_SECRET\")\n",
    "    \n",
    "    client = Client(api_key, api_secret, testnet=BINANCE_TESTNET)\n",
    "    print(f\"‚úÖ Connected to Binance {'Testnet' if BINANCE_TESTNET else 'Mainnet'}\")\n",
    "except Exception as e:\n",
    "    print(f\"‚ùå Connection Failed: {e}\")\n",
    "\n",
    "# Gemini Configuration\n",
    "GEMINI_API_KEY = os.getenv(\"GEMINI_API_KEY\")\n",
    "LLM_MODEL = \"gemini-flash-latest\"\n",
    "LLM_URL = f\"https://generativelanguage.googleapis.com/v1beta/models/{LLM_MODEL}:generateContent\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 66,
   "id": "81ef134a",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ AI Functions Loaded (With Retry Logic)\n"
     ]
    }
   ],
   "source": [
    "# ==========================================\n",
    "# 2. AI MODEL FUNCTIONS (ROBUST VERSION)\n",
    "# ==========================================\n",
    "\n",
    "def clean_json(text):\n",
    "    try:\n",
    "        text = re.sub(r\"```json\", \"\", text)\n",
    "        text = re.sub(r\"```\", \"\", text)\n",
    "        return json.loads(text.strip())\n",
    "    except:\n",
    "        return None\n",
    "\n",
    "def get_ai_decision(snapshot):\n",
    "    if not GEMINI_API_KEY:\n",
    "        return {\"action\": \"HOLD\", \"reason\": \"No API Key\", \"confidence\": 0}\n",
    "\n",
    "    prompt = f\"\"\"\n",
    "    You are a crypto futures trading bot.\n",
    "    Symbol: {snapshot['symbol']} | Price: {snapshot['price']}\n",
    "    RSI: {snapshot['indicators']['rsi']:.2f} | EMA50: {snapshot['indicators']['ema50']:.2f}\n",
    "    \n",
    "    Rules:\n",
    "    - RSI > 70 -> OPEN_SHORT\n",
    "    - RSI < 30 -> OPEN_LONG\n",
    "    - Price > EMA50 -> BULLISH bias\n",
    "    - Price < EMA50 -> BEARISH bias\n",
    "    \n",
    "    Return JSON ONLY: {{ \"action\": \"OPEN_LONG/OPEN_SHORT/HOLD\", \"reason\": \"short explanation\", \"confidence\": 0.0 to 1.0 }}\n",
    "    \"\"\"\n",
    "    \n",
    "    payload = {\"contents\": [{\"parts\": [{\"text\": prompt}]}]}\n",
    "    headers = {\"Content-Type\": \"application/json\", \"X-Goog-Api-Key\": GEMINI_API_KEY}\n",
    "\n",
    "    # RETRY LOGIC (Try 3 times before giving up)\n",
    "    for attempt in range(3):\n",
    "        try:\n",
    "            r = requests.post(LLM_URL, headers=headers, json=payload, timeout=10)\n",
    "            \n",
    "            # If Successful\n",
    "            if r.status_code == 200:\n",
    "                text = r.json()[\"candidates\"][0][\"content\"][\"parts\"][0][\"text\"]\n",
    "                return clean_json(text)\n",
    "            \n",
    "            # If Rate Limited (429), Wait and Retry\n",
    "            elif r.status_code == 429:\n",
    "                print(f\"‚ö† Rate Limit Hit (Attempt {attempt+1}/3). Cooling down 10s...\")\n",
    "                time.sleep(10)\n",
    "                continue # Try again\n",
    "                \n",
    "            else:\n",
    "                # Other API error\n",
    "                return {\"action\": \"HOLD\", \"reason\": f\"API Status {r.status_code}\", \"confidence\": 0}\n",
    "                \n",
    "        except Exception as e:\n",
    "            print(f\"‚ö† Network Error: {e}\")\n",
    "            time.sleep(2)\n",
    "\n",
    "    return {\"action\": \"HOLD\", \"reason\": \"Max Retries Exceeded\", \"confidence\": 0}\n",
    "\n",
    "print(\"‚úÖ AI Functions Loaded (With Retry Logic)\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 67,
   "id": "9cbbb049",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üì• Fetching last 500 candles for ETHUSDT...\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>time</th>\n",
       "      <th>open</th>\n",
       "      <th>high</th>\n",
       "      <th>low</th>\n",
       "      <th>close</th>\n",
       "      <th>volume</th>\n",
       "      <th>close_time</th>\n",
       "      <th>q_vol</th>\n",
       "      <th>trades</th>\n",
       "      <th>taker_buy_vol</th>\n",
       "      <th>taker_buy_q_vol</th>\n",
       "      <th>ignore</th>\n",
       "      <th>datetime</th>\n",
       "      <th>ema50</th>\n",
       "      <th>rsi</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>497</th>\n",
       "      <td>1768999200000</td>\n",
       "      <td>2919.37</td>\n",
       "      <td>2919.37</td>\n",
       "      <td>2916.06</td>\n",
       "      <td>2916.67</td>\n",
       "      <td>36869.302</td>\n",
       "      <td>1768999499999</td>\n",
       "      <td>107542556.65350</td>\n",
       "      <td>1127</td>\n",
       "      <td>897.320</td>\n",
       "      <td>2619577.25718</td>\n",
       "      <td>0</td>\n",
       "      <td>2026-01-21 12:40:00</td>\n",
       "      <td>2951.370258</td>\n",
       "      <td>27.455729</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>498</th>\n",
       "      <td>1768999500000</td>\n",
       "      <td>2916.67</td>\n",
       "      <td>2920.45</td>\n",
       "      <td>2915.39</td>\n",
       "      <td>2920.45</td>\n",
       "      <td>210551.716</td>\n",
       "      <td>1768999799999</td>\n",
       "      <td>614451267.40816</td>\n",
       "      <td>2128</td>\n",
       "      <td>110218.406</td>\n",
       "      <td>321814305.00318</td>\n",
       "      <td>0</td>\n",
       "      <td>2026-01-21 12:45:00</td>\n",
       "      <td>2950.157699</td>\n",
       "      <td>32.154038</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>499</th>\n",
       "      <td>1768999800000</td>\n",
       "      <td>2920.45</td>\n",
       "      <td>2924.31</td>\n",
       "      <td>2919.96</td>\n",
       "      <td>2924.00</td>\n",
       "      <td>218462.133</td>\n",
       "      <td>1769000099999</td>\n",
       "      <td>638537107.73516</td>\n",
       "      <td>920</td>\n",
       "      <td>217634.218</td>\n",
       "      <td>636118271.05496</td>\n",
       "      <td>0</td>\n",
       "      <td>2026-01-21 12:50:00</td>\n",
       "      <td>2949.131907</td>\n",
       "      <td>36.324931</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "              time     open     high      low    close      volume  \\\n",
       "497  1768999200000  2919.37  2919.37  2916.06  2916.67   36869.302   \n",
       "498  1768999500000  2916.67  2920.45  2915.39  2920.45  210551.716   \n",
       "499  1768999800000  2920.45  2924.31  2919.96  2924.00  218462.133   \n",
       "\n",
       "        close_time            q_vol  trades taker_buy_vol  taker_buy_q_vol  \\\n",
       "497  1768999499999  107542556.65350    1127       897.320    2619577.25718   \n",
       "498  1768999799999  614451267.40816    2128    110218.406  321814305.00318   \n",
       "499  1769000099999  638537107.73516     920    217634.218  636118271.05496   \n",
       "\n",
       "    ignore            datetime        ema50        rsi  \n",
       "497      0 2026-01-21 12:40:00  2951.370258  27.455729  \n",
       "498      0 2026-01-21 12:45:00  2950.157699  32.154038  \n",
       "499      0 2026-01-21 12:50:00  2949.131907  36.324931  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# ==========================================\n",
    "# 3. DATA INGESTION\n",
    "# ==========================================\n",
    "\n",
    "def get_historical_data(symbol, limit=1000):\n",
    "    print(f\"üì• Fetching last {limit} candles for {symbol}...\")\n",
    "    try:\n",
    "        klines = client.futures_klines(symbol=symbol, interval=TIMEFRAME, limit=limit)\n",
    "        df = pd.DataFrame(klines, columns=[\n",
    "            \"time\", \"open\", \"high\", \"low\", \"close\", \"volume\", \n",
    "            \"close_time\", \"q_vol\", \"trades\", \"taker_buy_vol\", \"taker_buy_q_vol\", \"ignore\"\n",
    "        ])\n",
    "        \n",
    "        # Convert types\n",
    "        df[\"close\"] = df[\"close\"].astype(float)\n",
    "        df[\"datetime\"] = pd.to_datetime(df[\"time\"], unit=\"ms\")\n",
    "        \n",
    "        # Calculate Technical Indicators\n",
    "        df[\"ema50\"] = EMAIndicator(df[\"close\"], window=50).ema_indicator()\n",
    "        df[\"rsi\"] = RSIIndicator(df[\"close\"], window=14).rsi()\n",
    "        \n",
    "        return df\n",
    "    except Exception as e:\n",
    "        print(f\"‚ùå Error: {e}\")\n",
    "        return pd.DataFrame()\n",
    "\n",
    "# Fetch Data\n",
    "df = get_historical_data(SYMBOL, limit=500)\n",
    "display(df.tail(3))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ffa4d696",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ü§ñ Starting AI Simulation (Slower speed to prevent Errors)...\n",
      "Analyzing 2026-01-21 12:10:00... ‚ö† Rate Limit Hit (Attempt 1/3). Cooling down 10s...\n",
      "‚ö† Rate Limit Hit (Attempt 2/3). Cooling down 10s...\n",
      "‚ö† Rate Limit Hit (Attempt 3/3). Cooling down 10s...\n",
      "Decision: HOLD\n",
      "Analyzing 2026-01-21 12:15:00... ‚ö† Rate Limit Hit (Attempt 1/3). Cooling down 10s...\n",
      "‚ö† Rate Limit Hit (Attempt 2/3). Cooling down 10s...\n",
      "‚ö† Rate Limit Hit (Attempt 3/3). Cooling down 10s...\n",
      "Decision: HOLD\n",
      "Analyzing 2026-01-21 12:20:00... ‚ö† Rate Limit Hit (Attempt 1/3). Cooling down 10s...\n",
      "‚ö† Rate Limit Hit (Attempt 2/3). Cooling down 10s...\n"
     ]
    },
    {
     "ename": "KeyboardInterrupt",
     "evalue": "",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mKeyboardInterrupt\u001b[0m                         Traceback (most recent call last)",
      "Cell \u001b[1;32mIn[68], line 23\u001b[0m\n\u001b[0;32m     16\u001b[0m snapshot \u001b[38;5;241m=\u001b[39m {\n\u001b[0;32m     17\u001b[0m     \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124msymbol\u001b[39m\u001b[38;5;124m\"\u001b[39m: SYMBOL,\n\u001b[0;32m     18\u001b[0m     \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mprice\u001b[39m\u001b[38;5;124m\"\u001b[39m: row[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mclose\u001b[39m\u001b[38;5;124m'\u001b[39m],\n\u001b[0;32m     19\u001b[0m     \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mindicators\u001b[39m\u001b[38;5;124m\"\u001b[39m: {\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mrsi\u001b[39m\u001b[38;5;124m\"\u001b[39m: row[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mrsi\u001b[39m\u001b[38;5;124m'\u001b[39m], \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mema50\u001b[39m\u001b[38;5;124m\"\u001b[39m: row[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mema50\u001b[39m\u001b[38;5;124m'\u001b[39m]}\n\u001b[0;32m     20\u001b[0m }\n\u001b[0;32m     22\u001b[0m \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124mf\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mAnalyzing \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mrow[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mdatetime\u001b[39m\u001b[38;5;124m'\u001b[39m]\u001b[38;5;132;01m}\u001b[39;00m\u001b[38;5;124m... \u001b[39m\u001b[38;5;124m\"\u001b[39m, end\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[1;32m---> 23\u001b[0m decision \u001b[38;5;241m=\u001b[39m \u001b[43mget_ai_decision\u001b[49m\u001b[43m(\u001b[49m\u001b[43msnapshot\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m     24\u001b[0m \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124mf\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mDecision: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mdecision[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124maction\u001b[39m\u001b[38;5;124m'\u001b[39m]\u001b[38;5;132;01m}\u001b[39;00m\u001b[38;5;124m\"\u001b[39m)\n\u001b[0;32m     26\u001b[0m \u001b[38;5;66;03m# Check Outcome\u001b[39;00m\n",
      "Cell \u001b[1;32mIn[66], line 47\u001b[0m, in \u001b[0;36mget_ai_decision\u001b[1;34m(snapshot)\u001b[0m\n\u001b[0;32m     45\u001b[0m \u001b[38;5;28;01melif\u001b[39;00m r\u001b[38;5;241m.\u001b[39mstatus_code \u001b[38;5;241m==\u001b[39m \u001b[38;5;241m429\u001b[39m:\n\u001b[0;32m     46\u001b[0m     \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124mf\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m‚ö† Rate Limit Hit (Attempt \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mattempt\u001b[38;5;241m+\u001b[39m\u001b[38;5;241m1\u001b[39m\u001b[38;5;132;01m}\u001b[39;00m\u001b[38;5;124m/3). Cooling down 10s...\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[1;32m---> 47\u001b[0m     \u001b[43mtime\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43msleep\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;241;43m10\u001b[39;49m\u001b[43m)\u001b[49m\n\u001b[0;32m     48\u001b[0m     \u001b[38;5;28;01mcontinue\u001b[39;00m \u001b[38;5;66;03m# Try again\u001b[39;00m\n\u001b[0;32m     50\u001b[0m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[0;32m     51\u001b[0m     \u001b[38;5;66;03m# Other API error\u001b[39;00m\n",
      "\u001b[1;31mKeyboardInterrupt\u001b[0m: "
     ]
    }
   ],
   "source": [
    "# ==========================================\n",
    "# 4. SIMULATION LOOP (BACKTEST)\n",
    "# ==========================================\n",
    "\n",
    "results = []\n",
    "print(\"ü§ñ Starting AI Simulation on Historical Data...\")\n",
    "\n",
    "# Loop through the last 10 candles (We skip the first 50 to allow EMA/RSI to warm up)\n",
    "# We stop at len(df)-1 because we need the 'next' candle to verify the result\n",
    "start_index = len(df) - 100\n",
    "end_index = len(df) - 1\n",
    "\n",
    "for i in range(start_index, end_index):\n",
    "    row = df.iloc[i]\n",
    "    next_row = df.iloc[i+1] # The future candle (Outcome)\n",
    "    \n",
    "    # 1. Create Snapshot\n",
    "    snapshot = {\n",
    "        \"symbol\": SYMBOL,\n",
    "        \"price\": row['close'],\n",
    "        \"indicators\": {\n",
    "            \"rsi\": row['rsi'],\n",
    "            \"ema50\": row['ema50']\n",
    "        }\n",
    "    }\n",
    "    \n",
    "    # 2. Ask AI\n",
    "    print(f\"Analyzing {row['datetime']} | Price: {row['close']} | RSI: {row['rsi']:.1f}\")\n",
    "    decision = get_ai_decision(snapshot)\n",
    "    \n",
    "    # 3. Determine Win/Loss\n",
    "    # We look at the NEXT candle's close vs current close\n",
    "    price_change = next_row['close'] - row['close']\n",
    "    \n",
    "    outcome = \"NEUTRAL\"\n",
    "    if decision['action'] == \"OPEN_LONG\":\n",
    "        outcome = \"WIN\" if price_change > 0 else \"LOSS\"\n",
    "    elif decision['action'] == \"OPEN_SHORT\":\n",
    "        outcome = \"WIN\" if price_change < 0 else \"LOSS\"\n",
    "        \n",
    "    # 4. Record Result\n",
    "    results.append({\n",
    "        \"Time\": row['datetime'],\n",
    "        \"Price\": row['close'],\n",
    "        \"AI_Action\": decision['action'],\n",
    "        \"AI_Confidence\": decision.get('confidence', 0),\n",
    "        \"Actual_Change\": round(price_change, 2),\n",
    "        \"Result\": outcome,\n",
    "        \"Reason\": decision.get('reason', 'N/A')\n",
    "    })\n",
    "    \n",
    "    # Sleep to respect API limits\n",
    "    time.sleep(2)\n",
    "\n",
    "# Create DataFrame\n",
    "results_df = pd.DataFrame(results)\n",
    "print(\"\\n‚úÖ Simulation Complete\")\n",
    "display(results_df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "00e06ef1",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üìä FAILURE ANALYSIS: Found 0 incorrect predictions.\n",
      "\n",
      "üéâ The AI was perfect in this sample!\n"
     ]
    }
   ],
   "source": [
    "# ==========================================\n",
    "# 5. FAILURE ANALYSIS REPORT\n",
    "# ==========================================\n",
    "\n",
    "# Filter for LOSSES\n",
    "failures = results_df[results_df['Result'] == 'LOSS']\n",
    "\n",
    "print(f\"üìä FAILURE ANALYSIS: Found {len(failures)} incorrect predictions.\\n\")\n",
    "\n",
    "if len(failures) > 0:\n",
    "    for index, row in failures.iterrows():\n",
    "        print(f\"‚ùå MISTAKE at {row['Time']}\")\n",
    "        print(f\"   AI Decision: {row['AI_Action']} (Confidence: {row['AI_Confidence']})\")\n",
    "        print(f\"   AI Reasoning: {row['Reason']}\")\n",
    "        print(f\"   Actual Market Move: {row['Actual_Change']}\")\n",
    "        print(\"-\" * 60)\n",
    "else:\n",
    "    print(\"üéâ The AI was perfect in this sample!\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
